# Гибкие разделители промптов

## Описание
Данное обновление внедряет систему универсальных разделителей для парсинга ответов ИИ. Теперь программа не привязана к жестким тегам "ПЕРЕВОД" и "КОНТЕКСТ", а может использовать любой заголовок, указанный в настройках конкретного промпта. Это позволяет создавать промпты с любой структурой вывода, не меняя код программы.

## Как это работает
1.  **Инструкция для ИИ**: В тексте промпта (поле `context`) вы просите ИИ использовать определенный заголовок (например, `БЫСТРОЕ ПОЯСНЕНИЕ:` и `ПОДРОБНОЕ РАЗЪЯСНЕНИЕ:`).
2.  **Настройка разделителя**: В файле `prompts.json` для этого пресета добавляется поле `"delimiter": "ПОДРОБНОЕ РАЗЪЯСНЕНИЕ"`.
3.  **Автоматический парсинг**: Программа при генерации ищет именно это слово в ответе ИИ. Всё, что ДО него, попадает в окно перевода, всё, что ПОСЛЕ — в окно контекста.

## Ключевые изменения в коде

### 1. Состояние приложения (`core/app_state.py`)
Добавлена поддержка хранения текущего разделителя в глобальном состоянии:
```python
@dataclass
class AppState:
    # ...
    context_delimiter: str = "КОНТЕКСТ" # Значение по умолчанию
```

### 2. Логика парсинга (`api/ai/base_provider.py`)
Метод `_extract_translation_and_context` стал динамическим. Он принимает `delimiter` и использует его для разделения текста:
```python
def _extract_translation_and_context(self, text: str, delimiter: str = "КОНТЕКСТ") -> Tuple[str, str]:
    # Создается регулярное выражение, включающее пользовательский разделитель
    context_patterns = [delimiter, 'КОНТЕКСТ', 'CONTEXT']
    context_regex = r'[*_]*(' + '|'.join(escaped_patterns) + r')[:*_]*'
    parts = re.split(context_regex, text, maxsplit=1, flags=re.IGNORECASE)
    # ...
```

### 3. Менеджер промптов (`core/prompts_manager.py`)
Добавлены инструменты для работы с новым полем:
*   `get_delimiter(name)`: извлекает разделитель из JSON-файла.
*   `update_active_prompts`: сохраняет разделитель в активное состояние приложения при выборе промпта.

### 4. Пользовательский интерфейс (`ui/main_window.py`)
Функция `on_prompt_select` теперь синхронизирована с разделителем:
```python
new_delimiter = preset.get("delimiter", "КОНТЕКСТ")
dependencies.update_active_prompts(new_translate, new_context, new_delimiter)
```

### 5. Интеграция с Anki (`anki_german_helper.py`)
Для обеспечения работы в альтернативном режиме запуска добавлена глобальная переменная `CONTEXT_DELIMITER` и обновлена функция `extract_translation_and_context`.

### 6. Конфигурация (`prompts.json`)
Обновлен ваш пресет "промт":
```json
"промт": {
  "translation": "...",
  "context": "...",
  "delimiter": "ПОДРОБНОЕ РАЗЪЯСНЕНИЕ"
}
```

---
*Документация составлена для фиксации изменений в системе обработки промптов.*
